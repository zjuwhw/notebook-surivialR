# Regression Analysis Using the Proportional Hazards Model

## Covariates and nonparametric Survival Models

As mentioned in last chapter, Lehmann alternative $S_1(t)=[S_0(t)]^{\psi}$ can be re-expressed in terms of the hazard functions, yielding the *proportional hazards assumption*,

$$h_1(t)=\psi h_0(t)$$

Extend the model to include covariate information in a vector $z$ as follows:

$$\psi = e^{z\beta}$$

We can model this by *partial likelihood*, which was initially developed by D.R. Cox (1972), so it is often referred to as the *Cox proportional hazards model*

## Comparing Two Survival Distributions Using a Partial Likelihood Function

Partial likelihood does not require the assumptions about the survival distributions (parametric survial distributions), which is required by the standard likelihood method in section 2.6.

Under the proportional hazards model, assuming one single binary covarite $z$, the hazard function for the i-th subject at the j-th failure time is

$$h_i(t_j)=h_0(t_j)\psi_i\text{, and }\psi_i=e^{z_i\beta}$$

, where

- i is the index of subject, $i=1,...,n$, with n being the sample size
- j is the index of failure time, $j=1,...,D$, with D being the number of failure times
- $z_i$ is the covariate (the simple case: $z_i=1$ when i-th subject in experimental group, or $z_i=0$ when i-th subject in the control group)
- $\beta$ is the effect size for the covariate

Consider the first failure time $t_1$ and we have one failure at $t_1$, the probability that Patient $i$ is **the** failure is

$$p_1=p_1(\text{subject i fails})=\frac{h_i(t_1)}{\sum_{k \in R_1}h_k(t_1)}=\frac{h_0(t_1)\psi_i}{\sum_{k\in R_1}h_0(t_1)\psi_k}=\frac{\psi_i}{\sum_{k\in R_i}\psi_k}$$

, where

- $R_1$ is the set of subjects at risks at time $t_1$ (i.e., all the subjects before the first failure)

A key fact here is that the baseline hazard $h_0(t_1)$ cancels out of the numerator and denominator.

We can repeat this calculation for the second failure time $t_2$ among the set $R_2$, which is the $R_1$ excluding the failure one and also the censored ones between $t_1$ and $t_2$. So the partial likelihood is

$$L(\psi)=p_1p_2...p_D$$

Consider the synethtic data in section 4.1,

```{r}
library(survival)
tt = c(6, 7, 10, 15, 19, 25)
delta = c(1, 0, 1, 1, 0, 1)
trt = c(0, 0, 1, 0, 1, 1)  ## group 0 or 1
summary(survfit(Surv(tt,delta)~1))
```

At the first failure time, $t_1=6$ and $R_1$ included six subjects at risk. Considering subject 1, 2, and 4 are in the control group ($z=0$) and subject 3, 5, and 6 are in the experiment group ($z=1$), we can have 
$$\psi_1=\psi_2=\psi_4=e^{0*\beta}=1$$

, and 

$$\psi_3=\psi_5=\psi_6=e^{1*\beta}=\psi$$

We observed the first subject (subject 1) failed at time 6, then

$$p_1=\frac{1}{3\psi+3}$$

Similarly, at the second failure time ($t_2=10$), the $R_2$ has 4 subjects at risk, excluding subject 1 failed in the first failure time and subject 2 censored at time 7. Subject 3 failed, and its probability is

$$p_2=\frac{\psi}{3\psi+1}$$.

Similarly, we can get

$$p_3=\frac{1}{2\psi+1}\text{ and }p_4=1$$

So the partial likelihood is

$$L(\psi)=p_1p_2p_3p_4=\frac{\psi}{(3\psi+3)(3\psi+1)(2\psi+1)}$$

Plug in $\psi=e^{\beta}$ and consider log partial likelihood, we can get

$$l(\beta)=\beta-ln(e^\beta+3)-ln(3e^\beta+1)-ln(2e^\beta+1)$$

The maximum partial likelihood estimate is

$$\hat{\beta}_{MPLE}=arg max_\psi l(\beta)$$

, which is independent of the baseline hazard function $h_0(t)$

```{r}
plsimple = function(beta){
    psi = exp(beta)
    l = beta-log(3*psi+3)-log(3*psi+1)-log(2*psi+1)
    return(l)
}

## fnscale=1 means the optim will find the maximum
result = optim(par=0, fn=plsimple, method="L-BFGS-B", control=list(fnscale=-1), lower=-3, upper=1)

result$par

betas = seq(-3,1,length.out=100)
plot(betas, plsimple(betas), type="l", xlab="beta", ylab="log partial likelihood")
```